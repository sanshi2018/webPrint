# 网络打印机程序 - 后端 PRD 文档

## 1. 引言

### 1.1 项目背景

本项目旨在构建一个运行在 Windows 操作系统上的网络打印机后端服务。该服务通过提供 Web API，实现对本地连接打印机的远程控制，支持外部用户通过前端界面上传文件进行打印。这将极大地提升打印的便捷性和可访问性，满足远程或多设备环境下的打印需求。

### 1.2 项目目标

- 构建一个稳定、高效的 **Java Spring Boot 3** 后端服务，负责处理打印逻辑。
- 实现文件（PDF, Word）的接收、解析与打印机驱动调用。
- 提供清晰的 RESTful API 接口，供前端或其他客户端调用。
- 确保多打印机选择及打印任务队列的稳定管理。
- 提供准确的打印任务状态反馈和详细的错误信息。

### 1.3 范围定义

本后端 PRD 范围涵盖：

- 文件上传与存储服务。
- 打印机设备发现与管理。
- 打印任务队列管理与执行。
- 与 Windows 本地打印驱动的集成。
- 后端 API 接口设计与实现。
- 错误处理与日志记录。

------

## 2. 功能需求

### 2.1 文件上传与管理服务

#### 2.1.1 文件上传接口

- **需求描述：** 提供一个 API 接口，允许前端上传打印文件。
- **API Endpoint:** `POST /api/print/upload`
- 请求参数:
  - `file` (MultipartFile): 上传的文件内容。
  - `printerId` (String): 目标打印机的唯一标识符（例如，打印机名称）。
  - `copies` (Integer): 打印份数 (范围: 1-99)。
  - `paperSize` (String): 纸张大小，例如 "A4", "A3", "Letter"。
  - `duplex` (String): 单双面打印模式 ("NONE" 单面, "LONG_EDGE" 双面长边翻转, "SHORT_EDGE" 双面短边翻转)。
  - `colorMode` (String): 彩色/黑白打印模式 ("COLOR" 彩色, "MONOCHROME" 黑白)。
- **文件格式校验：** 后端应在接收文件后，严格校验其格式。**只接受 PDF (.pdf) 和 Microsoft Word (.doc, .docx) 格式的文件**。对于不符合要求的文件，拒绝请求并返回错误码 `2001`。
- **文件大小限制：** 单个上传文件大小上限为 **50MB**。超出此限制返回错误码 `2002`。
- **临时文件存储：** 上传的文件应临时存储在服务器的指定目录下。**打印任务完成后，相应的临时文件必须立即从文件系统删除**，以节省存储空间并保护用户隐私。

#### 2.1.2 打印任务创建与入队

- **需求描述：** 成功上传文件并校验通过后，后端应将打印文件、打印参数和选定的打印机信息封装成一个打印任务对象，并将其加入打印任务队列。
- 处理逻辑：
  1. 接收并解析前端提交的打印请求。
  2. 对 `printerId` 进行有效性验证，确保选择的打印机存在且在线。
  3. 创建唯一的打印任务 ID。
  4. 将文件保存到临时目录。
  5. 构建 `PrintTask` 对象，包含：任务ID、文件路径、文件类型、打印机ID、打印参数（份数、纸张、单双面、色彩模式）、提交时间、当前状态。
  6. 将 `PrintTask` 对象添加到**打印任务队列**。

### 2.2 打印机设备管理服务

#### 2.2.1 获取可用打印机列表

- **需求描述：** 后端需要提供 API 接口，供前端获取当前 Windows 主机上所有已安装且可用的打印机列表。

- **API Endpoint:** `GET /api/print/printers`

- 返回数据:

   返回一个 JSON 数组，每个元素包含：

  - `id` (String): 打印机唯一标识符（通常为打印机名称）。
  - `name` (String): 打印机显示名称。
  - `status` (String): 打印机当前状态（例如 "Online", "Offline", "Ready", "Error", "Unknown"）。
  - **考虑是否提供更多信息，例如纸盒状态，墨水/碳粉状态，但初期可简化。**

### 2.3 打印任务队列管理与执行

#### 2.3.1 队列管理策略

- **需求描述：** 后端需要实现一个稳定可靠的打印任务队列管理机制。

- 实现细节：

  - **队列类型：** 采用**基于 FIFO（先进先出）原则的队列**。所有接收到的打印任务都将按提交顺序排队。

  - **并发控制：** 为了避免打印机过载和资源冲突，系统同一时间只允许**一个打印任务**进入 `打印中` 状态。其他任务在队列中等待。

  - 任务状态流转：

     打印任务应有明确的状态字段，并进行以下流转：

    - `PENDING`: 任务已提交并进入队列，等待处理。
    - `PROCESSING`: 任务正在被后端系统处理（例如，准备文件，调用打印 API）。
    - `PRINTING`: 任务已成功提交给打印机，打印机正在执行打印操作。
    - `COMPLETED`: 打印任务成功完成。
    - `FAILED`: 打印任务执行失败。
    - `CANCELED`: 打印任务被取消（未来可扩展）。

- **任务调度器：** 后端需要一个独立的线程或任务调度器来轮询队列，当有 `PENDING` 状态的任务且当前没有 `PRINTING` 任务时，从队列头部取出任务并开始处理。

#### 2.3.2 打印任务执行

- **需求描述：** 后端负责调用 Windows 系统 API 或 Java 打印 API 来实际执行打印操作。
- 实现细节：
  - PDF 打印：
    - 利用 Java 的 `java.awt.print` API 或第三方库（如 `Apache PDFBox`）来加载和打印 PDF 文件。
    - 需要正确处理 PDF 的页面设置、旋转、缩放等。
  - Word 打印：
    - Word 文档的打印通常更复杂，因为它需要 Microsoft Office 或兼容软件的支持。
    - **方案一（推荐）：** 考虑使用 **JNA (Java Native Access) 或 JNI (Java Native Interface)** 来调用 Windows COM 接口，与安装在本地的 Microsoft Word 应用程序进行自动化交互，实现文档打印。这要求服务器上安装 Word。
    - **方案二（备选，但可能复杂）：** 考虑集成 LibreOffice/OpenOffice，通过其命令行工具或 API 进行文档转换（例如转为 PDF）再进行打印。这需要额外安装 LibreOffice。
    - **初期先确保 Word 文档能通过某种方式被打印出来，即使是转换为 PDF 后打印。**
  - **打印参数传递：** 确保将前端传递的打印份数、纸张大小、单双面、彩色/黑白模式正确地应用到打印任务中。
  - **异常处理：** 在打印过程中捕获所有可能的异常（如打印机错误、文件损坏），并更新任务状态为 `FAILED`，记录详细错误信息。

### 2.4 打印任务状态查询与反馈

#### 2.4.1 查询任务状态

- **需求描述：** 提供一个 API 接口，允许前端查询特定打印任务的当前状态。

- **API Endpoint:** `GET /api/print/status/{taskId}`

- 返回数据:

   返回 JSON 对象，包含：

  - `taskId` (String): 打印任务 ID。
  - `status` (String): 任务当前状态 (`PENDING`, `PROCESSING`, `PRINTING`, `COMPLETED`, `FAILED`)。
  - `message` (String, 可选): 当前状态的详细描述或错误信息。
  - `progress` (Integer, 可选): 打印进度百分比（如果打印机驱动支持）。

#### 2.4.2 错误码定义

后端返回的通用错误码及含义如下：

| 错误码 | HTTP 状态码                 | 含义                  | 描述                                                         |
| ------ | --------------------------- | --------------------- | ------------------------------------------------------------ |
| `1000` | `200 OK`                    | **成功**              | 请求处理成功，打印任务已提交或操作完成。                     |
| `2001` | `400 Bad Request`           | **文件格式不支持**    | 上传的文件非 PDF 或 Word 格式。                              |
| `2002` | `413 Payload Too Large`     | **文件过大**          | 上传文件超过系统允许的最大大小限制（当前 50MB）。            |
| `2003` | `500 Internal Server Error` | **文件上传失败**      | 文件在上传过程中发生错误，可能由于网络问题或存储权限。       |
| `3001` | `404 Not Found`             | **打印机未找到**      | 用户选择的打印机在系统中不存在或当前不可用。                 |
| `3002` | `503 Service Unavailable`   | **打印机离线**        | 目标打印机处于离线状态，无法执行打印任务。                   |
| `3003` | `500 Internal Server Error` | **打印任务提交失败**  | 系统未能成功将打印任务发送到打印机。可能由于驱动问题或系统权限不足。 |
| `3004` | `503 Service Unavailable`   | **打印机缺纸/卡纸**   | 打印机报告缺纸或卡纸错误。                                   |
| `3005` | `503 Service Unavailable`   | **打印耗材不足**      | 打印机墨水/碳粉不足。                                        |
| `3006` | `400 Bad Request`           | **打印任务取消**      | 打印任务被用户或系统管理员取消。                             |
| `4001` | `400 Bad Request`           | **请求参数缺失/无效** | 请求中缺少必要的参数或参数值不合法（如打印份数为负数）。     |
| `5000` | `500 Internal Server Error` | **内部服务器错误**    | 系统内部发生未知错误。                                       |

导出到 Google 表格

------

## 3. 技术架构与选型

### 3.1 整体架构

- **后端服务：** 独立的 Java Spring Boot 应用程序，运行在 Windows 主机上。
- **API 接口：** 提供 RESTful API 接口，与前端进行数据交互。

### 3.2 后端技术栈

- **语言与框架：** Java 17+ / Spring Boot 3.x

- **构建工具：** Maven

- 打印服务集成：

  - **核心打印库：** 主要使用 **`java.awt.print`** 包进行通用打印控制。

  - **PDF 处理：** **`Apache PDFBox`** (或 `iText` 社区版) 用于 PDF 文件的加载、解析和打印。

  - Word 处理：

     \* 

    `JNA (Java Native Access)`

     用于调用 Windows API 或 COM 接口，与本地安装的 Microsoft Word 应用程序进行自动化交互，实现 Word 文档的打印。

    这是目前首选的 Word 打印方案。

    - 需确保 Windows 主机上已安装 Microsoft Word。

- **文件存储：** 本地文件系统 (用于临时存储上传的文件)。

- **Web 服务器：** Spring Boot 内嵌 Tomcat。

- **日志框架：** SLF4J + Logback，用于记录应用日志和打印任务日志。

- **API 文档：** **Springdoc OpenAPI (Swagger UI)**，用于自动生成和展示后端 API 文档，便于前端和测试人员查阅。

### 3.3 数据库 (暂定)

- **初期阶段：** 打印任务队列和状态可暂时基于内存实现，无需数据库。
- **未来扩展：** 如果需要持久化打印任务记录、用户管理或更复杂的队列管理，将考虑引入轻量级数据库，如 **H2 Database (嵌入式)** 或 **PostgreSQL/MySQL (独立部署)**。**当前版本不包含数据库。**

------

## 4. 部署与环境

### 4.1 部署环境

- **操作系统：** Windows 10/11 (64位) 或 Windows Server 2016/2019/2022。
- **Java 运行环境：** OpenJDK 17 或 Oracle JDK 17 及以上版本。
- **打印机驱动：** 确保 Windows 主机已正确安装 HP LaserJet M1005 (或其他目标打印机) 的官方驱动，并能正常进行本地打印测试。
- **Microsoft Word：** 如果需要支持 Word 文档打印，则 Windows 主机上必须安装 Microsoft Word 应用程序。
- **网络配置：** 后端服务端口（例如 8080）需在防火墙中开放，以便前端或其他客户端访问。

### 4.2 部署方式

- 后端打包成一个可执行的 **JAR 包**。
- 可通过命令行 (`java -jar your-app.jar`) 启动，或者配置为 Windows 服务（如使用 NSSM 工具），实现开机自启动和后台运行。

------

## 5. 非功能性需求

### 5.1 性能

- **API 响应时间：** 除文件上传外，其他 API 接口（如获取打印机列表、查询任务状态）响应时间应在 **500ms** 内。

- **文件上传速度：** 取决于网络带宽，但后端处理应尽可能快，在文件上传完成后 **3秒内** 将任务加入队列并返回响应。

- **打印处理效率：** 后端从队列中取出任务到实际提交给打印机的时间应控制在 **5秒内**。

- 并发处理：

   \* 

  API 并发：

   后端应能处理 

  10-20 个并发 API 请求

  。

  - **打印任务并发：** 严格遵循**单个打印任务串行执行**的原则，即同一时间只有一个任务处于 `PRINTING` 状态。

### 5.2 安全性

- API 安全：
  - **访问控制：** 初期可考虑基于 IP 地址白名单进行简单的访问限制。未来可考虑引入更复杂的认证机制（如 API Key）。
  - **数据传输：** 建议通过 **HTTPS** 进行 API 通信，确保数据传输加密。
- 文件安全：
  - **上传校验：** 严格的文件格式和大小校验，防止恶意文件上传。
  - **临时存储：** 临时文件存储目录应有适当的访问权限控制。
  - **文件清理：** 打印完成后立即清理临时文件，降低风险。
- **日志安全：** 避免在日志中记录敏感信息。

### 5.3 可用性

- **容错性：** 打印过程中出现异常（如打印机离线、缺纸），后端应能捕获并正确处理，更新任务状态，并记录详细错误信息。
- **日志记录：** 记录详细的运行时日志，包括 API 请求、文件处理、打印机调用、任务状态变更等，方便故障排查。
- **可监控性：** 考虑暴露 Actuator 端点，便于后期集成监控系统（如 Prometheus + Grafana）来监控应用状态和性能。

### 5.4 可维护性

- **代码规范：** 遵循 Spring Boot 和 Java 社区的最佳实践和编码规范。
- **模块化：** 代码结构清晰，模块职责明确。
- **文档：** 核心类、方法和 API 接口应有清晰的 Javadoc 注释和 Swagger UI 文档。
- **依赖管理：** 合理管理第三方依赖，避免版本冲突。

------

## 6. 待明确及风险评估

### 6.1 待明确事项 (后续讨论)

- **打印参数细节：** 纸张大小的完整列表、单双面打印的具体实现细节（例如 `LONG_EDGE` 和 `SHORT_EDGE` 如何映射到驱动）。
- **Word 打印的准确实现方案：** 需技术团队对 JNA 调用 Microsoft Word 进行详细调研，评估其稳定性、性能和对服务器环境的依赖性（例如 Word 版本）。如果遇到较大障碍，需准备备选方案（如强制用户转为 PDF 上传）。
- **打印机状态的细化：** 除了在线/离线，是否需要获取更详细的打印机错误状态（如卡纸、缺墨）？这可能需要更深入的 Windows API 调用。
- **日志级别和内容细化：** 明确哪些信息需要以什么级别记录到日志中。

### 6.2 风险评估

- **Windows API 调用复杂性：** Java 通过 JNA/JNI 调用 Windows 本地打印机驱动或 COM 接口具有一定复杂性，可能存在兼容性问题、内存泄漏或崩溃的风险。
- **Word 自动化稳定性：** 通过程序控制 Microsoft Word 进行打印，可能受 Word 版本、安全设置、后台运行状态等因素影响，稳定性是主要挑战。
- **打印机驱动兼容性：** 虽然目标是 HP LaserJet M1005，但不同版本的驱动或未来的其他打印机型号可能引入新的兼容性问题。
- **并发打印与队列管理：** 虽然设定为串行打印，但在高并发请求下，队列管理和任务调度的健壮性仍需充分测试。
- **文件安全性：** 恶意文件上传的风险，尽管有格式和大小限制，仍需关注潜在的安全漏洞。

------

这份后端 PRD 已经包含了后端开发所需的绝大部分信息。请您审阅，特别是关于 Word 打印的实现方案，这是当前最需要技术团队深入调研和确认的关键点。

还有其他需要我细化或补充的地方吗？